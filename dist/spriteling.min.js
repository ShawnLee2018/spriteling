!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Spriteling=t()}(this,function(){"use strict";var i=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};var a=function(e,t){var r,n;if(!e.nodeName)return t(new Error("First argument must be an image element"));if("img"!==e.nodeName.toLowerCase())return t(new Error("Element supplied is not an image"));if(e.src&&e.complete&&void 0!==e.naturalWidth)return t(null,!0);function i(){n?e.detachEvent("onload",i):e.removeEventListener("load",i,!1),t(null,!1)}(n=!e.addEventListener)?e.attachEvent("onload",i):e.addEventListener("load",i,!1),(e.readyState||e.complete)&&(r=e.src,e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",e.src=r)},e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};for(var t,n=(function(o){(function(){var e,t,r,n,i,a;"undefined"!=typeof performance&&null!==performance&&performance.now?o.exports=function(){return performance.now()}:"undefined"!=typeof process&&null!==process&&process.hrtime?(o.exports=function(){return(e()-i)/1e6},t=process.hrtime,n=(e=function(){var e;return 1e9*(e=t())[0]+e[1]})(),a=1e9*process.uptime(),i=n-a):Date.now?(o.exports=function(){return Date.now()-r},r=Date.now()):(o.exports=function(){return(new Date).getTime()-r},r=(new Date).getTime())}).call(e)}(t={exports:{}},t.exports),t.exports),r="undefined"==typeof window?e:window,o=["moz","webkit"],l="AnimationFrame",p=r["request"+l],s=r["cancel"+l]||r["cancelRequest"+l],h=0;!p&&h<o.length;h++)p=r[o[h]+"Request"+l],s=r[o[h]+"Cancel"+l]||r[o[h]+"CancelRequest"+l];if(!p||!s){var d=0,u=0,c=[];p=function(e){if(0===c.length){var t=n(),r=Math.max(0,1e3/60-(t-d));d=r+t,setTimeout(function(){for(var e=c.slice(0),t=c.length=0;t<e.length;t++)if(!e[t].cancelled)try{e[t].callback(d)}catch(e){setTimeout(function(){throw e},0)}},Math.round(r))}return c.push({handle:++u,callback:e,cancelled:!1}),u},s=function(e){for(var t=0;t<c.length;t++)c[t].handle===e&&(c[t].cancelled=!0)}}var f=function(e){return p.call(r,e)};f.cancel=function(){s.apply(r,arguments)};var m={play:!0,delay:50,tempo:1,run:1,reversed:!(f.polyfill=function(e){e||(e=r),e.requestAnimationFrame=p,e.cancelAnimationFrame=s}),outOfViewStop:!1,script:[],lastTime:0,nextDelay:0,currentFrame:-1,currentSprite:1,onPlay:null,onStop:null,onFrame:null};return function(e,t,r){void 0===r&&(r=!1);var o=this;if(this.spriteSheet={loaded:!1,url:null,cols:null,rows:null,cutOffFrames:0,top:null,bottom:null,left:null,right:null,startSprite:1,totalSprites:0,sheetWidth:0,sheetHeight:0,frameWidth:0,frameHeight:0,animations:{},onLoaded:null},this.showSprite=function(e){o.playhead.play=!1,o.drawFrame({sprite:e})},this.currentSprite=function(){return o.playhead.currentSprite},this.addScript=function(e,t){o.spriteSheet.animations[e]=t},this.setTempo=function(e){o.playhead.tempo=e},this.getTempo=function(){return o.playhead.tempo},this.next=function(){if(!o.spriteSheet.loaded)return!1;o.playhead.currentFrame+=1,o.playhead.currentFrame>o.playhead.script.length-1&&(o.playhead.currentFrame=0),o.playhead.currentFrame===o.playhead.script.length-1&&(o.playhead.run-=1);var e=o.playhead.script[o.playhead.currentFrame];return o.drawFrame(e)},this.previous=function(){if(!o.spriteSheet.loaded)return!1;o.playhead.currentFrame-=1,o.playhead.currentFrame<0&&(o.playhead.currentFrame=o.playhead.script.length-1),0===o.playhead.currentFrame&&(o.playhead.run-=1);var e=o.playhead.script[o.playhead.currentFrame];return o.drawFrame(e)},this.goTo=function(e){if(!o.spriteSheet.loaded)return!1;var t=Math.floor(e/o.playhead.script.length);e=Math.floor(e-t*o.playhead.script.length),o.playhead.currentFrame=e;var r=o.playhead.script[o.playhead.currentFrame];return void 0===r&&(o.log("info","frame: "+o.playhead.currentFrame+", sprite: "+r.sprite),o.drawFrame(r))},this.play=function(e,t){if(!o.spriteSheet.loaded)return setTimeout(function(){o.play(e,t)},50),!1;if(e||t){var r=void 0;"string"!=typeof e||t?"string"==typeof e&&"object"==typeof t?r=o.spriteSheet.animations[e]:"object"!=typeof e||t||(t=e,r=o.playhead.script):o.spriteSheet.animations[e]?(o.log("info",'playing animation "'+e+'"'),r=o.spriteSheet.animations[e]):o.log("error",'animation "'+e+'" not found'),t&&(r||(o.log("info",'playing animation "all"'),r=o.spriteSheet.animations.all),o.playhead=i({},m,{script:r},t))}else o.playhead.play||(0===o.playhead.run&&(o.playhead.run=1),o.playhead.play=!0);0!==o.playhead.run&&o.loop(),"function"==typeof o.playhead.onPlay&&o.playhead.onPlay()},this.isPlaying=function(){return o.playhead.play},this.reverse=function(){o.playhead.reversed=!o.playhead.reversed},this.isReversed=function(){return o.playhead.reversed},this.stop=function(){o.playhead.play=!1,"function"==typeof o.playhead.onStop&&o.playhead.onStop()},this.reset=function(){o.goTo(0)},this.loadSpriteSheet=function(){var t=new Image;t.src=o.spriteSheet.url,a(t,function(){if(!o.spriteSheet.loaded){o.spriteSheet.loaded=!0,o.log("info","loaded: "+o.spriteSheet.url+", sprites "+o.spriteSheet.cols+" x "+o.spriteSheet.rows),o.spriteSheet.sheetWidth=t.width,o.spriteSheet.sheetHeight=t.height,o.spriteSheet.frameWidth=o.spriteSheet.sheetWidth/o.spriteSheet.cols,o.spriteSheet.frameHeight=o.spriteSheet.sheetHeight/o.spriteSheet.rows,o.spriteSheet.totalSprites=o.spriteSheet.cols*o.spriteSheet.rows-o.spriteSheet.cutOffFrames,o.spriteSheet.frameWidth%1!=0&&o.log("error","frameWidth "+o.spriteSheet.frameWidth+" is not a whole number"),o.spriteSheet.frameHeight%1!=0&&o.log("error","frameHeight "+o.spriteSheet.frameHeight+" is not a whole number"),o.element.style.position="absolute",o.element.style.width=o.spriteSheet.frameWidth+"px",o.element.style.height=o.spriteSheet.frameHeight+"px",o.element.style.backgroundImage="url("+o.spriteSheet.url+")",o.element.style.backgroundPosition="0 0",null!==o.spriteSheet.top&&("center"===o.spriteSheet.top?(o.element.style.top="50%",o.element.style.marginTop=o.spriteSheet.frameHeight/2*-1+"px"):o.element.style.top=o.spriteSheet.top+"px"),null!==o.spriteSheet.right&&(o.element.style.right=o.spriteSheet.right+"px"),null!==o.spriteSheet.bottom&&(o.element.style.bottom=o.spriteSheet.bottom+"px"),null!==o.spriteSheet.left&&("center"===o.spriteSheet.left?(o.element.style.left=o.spriteSheet.left+"px",o.element.style.marginLeft=o.spriteSheet.frameWidth/2*-1+"px"):o.element.style.left=o.spriteSheet.left+"px"),o.autoScript();var e={script:o.spriteSheet.animations.all};o.playhead=i({},m,e),1<o.spriteSheet.startSprite&&o.spriteSheet.startSprite<=o.spriteSheet.totalSprites&&o.showSprite(o.spriteSheet.startSprite),"function"==typeof o.spriteSheet.onLoaded&&o.spriteSheet.onLoaded()}})},this.autoScript=function(){for(var e=[],t=0;t<o.spriteSheet.totalSprites;t++)e[t]={sprite:t+1};o.addScript("all",e)},this.loop=function(e){var t=f(o.loop);if(null!==o.element&&o.spriteSheet.loaded)if(o.playhead.play){if(e-o.playhead.lastTime>=o.playhead.nextDelay)if(null!==o.element.offsetParent&&o.inViewport())if(0===o.playhead.run)o.stop();else{o.playhead.reversed?o.previous():o.next();var r=o.playhead.script[o.playhead.currentFrame];o.playhead.nextDelay=r.delay?r.delay:o.playhead.delay,o.playhead.nextDelay/=o.playhead.tempo,o.playhead.lastTime=e,o.log("info","frame: "+o.playhead.currentFrame+", sprite: "+r.sprite+", delay: "+o.playhead.nextDelay+", run: "+o.playhead.run)}else o.playhead.outOfViewStop&&o.stop()}else f.cancel(t)},this.drawFrame=function(e){if(e.sprite===o.playhead.currentSprite)return!1;o.playhead.currentSprite=e.sprite;var t=o.element.getBoundingClientRect(),r=Math.ceil(e.sprite/o.spriteSheet.cols),n=e.sprite-(r-1)*o.spriteSheet.cols,i=(n-1)*o.spriteSheet.frameWidth*-1,a=(r-1)*o.spriteSheet.frameHeight*-1;return(r>o.spriteSheet.rows||n>o.spriteSheet.cols)&&o.log("error","position "+e.sprite+" out of bound'"),o.element.style.backgroundPosition=i+"px "+a+"px",e.top&&(o.element.style.top=t.top+e.top+"px"),e.right&&(o.element.style.top=t.right+e.right+"px"),e.bottom&&(o.element.style.top=t.bottom+e.bottom+"px"),e.left&&(o.element.style.top=t.left+e.left+"px"),"function"==typeof o.playhead.onFrame&&o.playhead.onFrame(),!0},this.inViewport=function(){var e=o.element.getBoundingClientRect(),t=window.scrollY>=e.top+o.spriteSheet.frameHeight,r=window.innerHeight+window.scrollY<=e.top,n=window.scrollX>=e.left+o.spriteSheet.frameWidth,i=window.innerWidth+window.scrollX<=e.left;return!(t||r||n||i)},this.log=function(e,t){"undefined"==typeof console||"info"===e&&!o.debug||console[e]("SpriteLing: "+t)},t&&(this.element="string"==typeof t?document.querySelector(t):t),this.element||(this.log("warn",'element "'+t+'" not found, created new element instead'),this.element=document.createElement("div"),document.body.appendChild(this.element)),this.spriteSheet=i({},this.spriteSheet,e),this.playhead=i({},m),this.debug=r,e.cols||this.log("error","options.cols not set"),e.rows||this.log("error","options.rows not set"),!e.url){var n=window.getComputedStyle(this.element).getPropertyValue("background-image");"none"===n?this.log("error","no spritesheet image found, please specify it with options.url or set as css background"):this.spriteSheet.url=n.replace(/"/g,"").replace(/url\(|\)$/gi,"")}this.loadSpriteSheet()}});
