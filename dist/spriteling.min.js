!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Spriteling=t()}(this,function(){"use strict";var i=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e};var o=function(e,t){var r,n;if(!e.nodeName)return t(new Error("First argument must be an image element"));if("img"!==e.nodeName.toLowerCase())return t(new Error("Element supplied is not an image"));if(e.src&&e.complete&&void 0!==e.naturalWidth)return t(null,!0);function i(){n?e.detachEvent("onload",i):e.removeEventListener("load",i,!1),t(null,!1)}(n=!e.addEventListener)?e.attachEvent("onload",i):e.addEventListener("load",i,!1),(e.readyState||e.complete)&&(r=e.src,e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",e.src=r)},e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};for(var t,n=(function(a){(function(){var e,t,r,n,i,o;"undefined"!=typeof performance&&null!==performance&&performance.now?a.exports=function(){return performance.now()}:"undefined"!=typeof process&&null!==process&&process.hrtime?(a.exports=function(){return(e()-i)/1e6},t=process.hrtime,n=(e=function(){var e;return 1e9*(e=t())[0]+e[1]})(),o=1e9*process.uptime(),i=n-o):Date.now?(a.exports=function(){return Date.now()-r},r=Date.now()):(a.exports=function(){return(new Date).getTime()-r},r=(new Date).getTime())}).call(e)}(t={exports:{}},t.exports),t.exports),r="undefined"==typeof window?e:window,a=["moz","webkit"],l="AnimationFrame",s=r["request"+l],p=r["cancel"+l]||r["cancelRequest"+l],d=0;!s&&d<a.length;d++)s=r[a[d]+"Request"+l],p=r[a[d]+"Cancel"+l]||r[a[d]+"CancelRequest"+l];if(!s||!p){var h=0,u=0,c=[];s=function(e){if(0===c.length){var t=n(),r=Math.max(0,1e3/60-(t-h));h=r+t,setTimeout(function(){for(var e=c.slice(0),t=c.length=0;t<e.length;t++)if(!e[t].cancelled)try{e[t].callback(h)}catch(e){setTimeout(function(){throw e},0)}},Math.round(r))}return c.push({handle:++u,callback:e,cancelled:!1}),u},p=function(e){for(var t=0;t<c.length;t++)c[t].handle===e&&(c[t].cancelled=!0)}}var f=function(e){return s.call(r,e)};f.cancel=function(){p.apply(r,arguments)};var m={play:!0,delay:50,tempo:1,run:-1,reversed:!(f.polyfill=function(e){e||(e=r),e.requestAnimationFrame=s,e.cancelAnimationFrame=p}),script:[],lastTime:0,nextDelay:0,currentFrame:-1,currentSprite:1,onPlay:null,onStop:null,onFrame:null,onOutOfView:null};return function(e,t,r){void 0===r&&(r=!1);var p=this;if(this.spriteSheet={loaded:!1,url:null,cols:null,rows:null,cutOffFrames:0,top:null,bottom:null,left:null,right:null,startSprite:1,downsizeRatio:1,totalSprites:0,sheetWidth:0,sheetHeight:0,frameWidth:0,frameHeight:0,animations:{},onLoaded:null},this.showSprite=function(e){p.playhead.play=!1,p.drawFrame({sprite:e})},this.currentSprite=function(){return p.playhead.currentSprite},this.addScript=function(e,t){p.spriteSheet.animations[e]=t},this.play=function(e,t){if(!p.spriteSheet.loaded)return setTimeout(function(){p.play(e,t)},50),!1;if(e||t){var r=void 0,n={};"string"!=typeof e||t?"string"==typeof e&&"object"==typeof t?(r=p.spriteSheet.animations[e],n=t):"object"!=typeof e||t||(r=p.playhead.script,n=e):p.spriteSheet.animations[e]?(p.log("info",'playing animation "'+e+'"'),r=p.spriteSheet.animations[e]):p.log("error",'animation "'+e+'" not found'),r||(p.log("info",'playing animation "all"'),r=p.spriteSheet.animations.all),p.playhead=i({},m,{script:r},n)}else p.playhead.play||(0===p.playhead.run&&(p.playhead.run=1),p.playhead.play=!0);0!==p.playhead.run&&p.loop(),"function"==typeof p.playhead.onPlay&&p.playhead.onPlay()},this.isPlaying=function(){return p.playhead.play},this.setTempo=function(e){p.playhead.tempo=e},this.getTempo=function(){return p.playhead.tempo},this.next=function(){if(!p.spriteSheet.loaded)return!1;p.playhead.currentFrame+=1,p.playhead.currentFrame>p.playhead.script.length-1&&(p.playhead.currentFrame=0),p.playhead.currentFrame===p.playhead.script.length-1&&(p.playhead.run-=1);var e=p.playhead.script[p.playhead.currentFrame];return p.drawFrame(e)},this.previous=function(){if(!p.spriteSheet.loaded)return!1;p.playhead.currentFrame-=1,p.playhead.currentFrame<0&&(p.playhead.currentFrame=p.playhead.script.length-1),0===p.playhead.currentFrame&&(p.playhead.run-=1);var e=p.playhead.script[p.playhead.currentFrame];return p.drawFrame(e)},this.goTo=function(e){if(!p.spriteSheet.loaded)return!1;var t=Math.floor(e/p.playhead.script.length);e=Math.floor(e-t*p.playhead.script.length),p.playhead.currentFrame=e;var r=p.playhead.script[p.playhead.currentFrame];return void 0!==typeof r&&(p.log("info","frame: "+p.playhead.currentFrame+", sprite: "+r.sprite),p.drawFrame(r))},this.reverse=function(){p.playhead.reversed=!p.playhead.reversed},this.isReversed=function(){return p.playhead.reversed},this.stop=function(){p.playhead.play=!1,"function"==typeof p.playhead.onStop&&p.playhead.onStop()},this.reset=function(){p.goTo(0)},this.destroy=function(){p.playhead.play=!1,p.element.parentNode.removeChild(p.element)},this.loadSpriteSheet=function(){var n=new Image;n.src=p.spriteSheet.url,o(n,function(){if(!p.spriteSheet.loaded){var e=p.spriteSheet,t=p.element;e.loaded=!0,p.log("info","loaded: "+e.url+", sprites "+e.cols+" x "+e.rows),e.sheetWidth=n.width,e.sheetHeight=n.height,e.frameWidth=e.sheetWidth/e.cols/e.downsizeRatio,e.frameHeight=e.sheetHeight/e.rows/e.downsizeRatio,e.totalSprites=e.cols*e.rows-e.cutOffFrames,e.frameWidth%1!=0&&p.log("error","frameWidth "+e.frameWidth+" is not a whole number"),e.frameHeight%1!=0&&p.log("error","frameHeight "+e.frameHeight+" is not a whole number"),t.style.position="absolute",t.style.width=e.frameWidth+"px",t.style.height=e.frameHeight+"px",t.style.backgroundImage="url("+e.url+")",t.style.backgroundPosition="0 0",1<e.downsizeRatio&&(t.style.backgroundSize=e.sheetWidth/e.downsizeRatio+"px "+e.sheetHeight/e.downsizeRatio+"px"),null!==e.top&&("center"===e.top?(t.style.top="50%",t.style.marginTop=e.frameHeight/2*-1+"px"):t.style.top=e.top+"px"),null!==e.right&&(t.style.right=e.right+"px"),null!==e.bottom&&(t.style.bottom=e.bottom+"px"),null!==e.left&&("center"===e.left?(t.style.left=e.left+"px",t.style.marginLeft=e.frameWidth/2*-1+"px"):t.style.left=e.left+"px"),p.autoScript();var r={script:e.animations.all};p.playhead=i({},m,r),1<e.startSprite&&e.startSprite<=e.totalSprites&&p.showSprite(e.startSprite),"function"==typeof e.onLoaded&&e.onLoaded()}})},this.autoScript=function(){for(var e=[],t=0;t<p.spriteSheet.totalSprites;t++)e[t]={sprite:t+1};p.addScript("all",e)},this.loop=function(e){var t=f(p.loop),r=p.spriteSheet,n=p.playhead,i=p.element;if(null!==i&&r.loaded)if(n.play){if(e-n.lastTime>=n.nextDelay)if(null!==i.offsetParent&&p.inViewport())if(0===n.run)p.stop();else{n.reversed?p.previous():p.next();var o=n.script[n.currentFrame];n.nextDelay=o.delay?o.delay:n.delay,n.nextDelay/=n.tempo,n.lastTime=e,p.log("info","frame: "+n.currentFrame+", sprite: "+o.sprite+", delay: "+n.nextDelay+", run: "+n.run)}else"function"==typeof n.onOutOfView&&n.onOutOfView()}else f.cancel(t)},this.drawFrame=function(e){var t=p.spriteSheet,r=p.playhead,n=p.element;if(e.sprite===r.currentSprite)return!1;var i=n.getBoundingClientRect(),o=Math.ceil(e.sprite/t.cols),a=e.sprite-(o-1)*t.cols,l=(a-1)*t.frameWidth*-1,s=(o-1)*t.frameHeight*-1;return(o>t.rows||a>t.cols)&&p.log("error","position "+e.sprite+" out of bound'"),r.currentSprite=e.sprite,n.style.backgroundPosition=l+"px "+s+"px",e.top&&(n.style.top=i.top+e.top+"px"),e.right&&(n.style.right=i.right+e.right+"px"),e.bottom&&(n.style.bottom=i.bottom+e.bottom+"px"),e.left&&(n.style.left=i.left+e.left+"px"),"function"==typeof r.onFrame&&r.onFrame(r.currentFrame),!0},this.inViewport=function(){var e=p.spriteSheet,t=p.element.getBoundingClientRect();return 0<=t.top+e.frameHeight&&0<=t.left+e.frameWidth&&t.bottom-e.frameHeight<=(window.innerHeight||document.documentElement.clientHeight)&&t.right-e.frameWidth<=(window.innerWidth||document.documentElement.clientWidth)},this.log=function(e,t){"undefined"==typeof console||"info"===e&&!p.debug||console[e]("Spriteling: "+t)},t&&(this.element="string"==typeof t?document.querySelector(t):t),this.element||(void 0!==this.element&&this.log("warn",'element "'+t+'" not found, created new element instead'),this.element=document.createElement("div"),document.body.appendChild(this.element)),this.spriteSheet=i({},this.spriteSheet,e),this.playhead=i({},m),this.debug=r,e.cols||this.log("error","options.cols not set"),e.rows||this.log("error","options.rows not set"),!e.url){var n=window.getComputedStyle(this.element).getPropertyValue("background-image");"none"===n?this.log("error","no spritesheet image found, please specify it with options.url or set as css background"):this.spriteSheet.url=n.replace(/"/g,"").replace(/url\(|\)$/gi,"")}this.loadSpriteSheet()}});
